<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="#{app.title}">Legislative Codelists</title>
    <link rel="icon" type="image/svg+xml" th:href="@{/favicon.svg}">
    <link th:href="@{/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/bootstrap-icons.css}" rel="stylesheet">
    <style>
        .navbar { padding: 0.75rem 1rem; }
        .navbar-brand { font-weight: 600; font-size: 1.25rem; }
        .navbar-nav .nav-link { padding: 0.5rem 1rem; }
        .nav-divider { width: 1px; height: 24px; background-color: rgba(255,255,255,0.3); margin: 0 0.5rem; align-self: center; }
        .user-dropdown .dropdown-toggle::after { margin-left: 0.5rem; }
        .dropdown-menu { border: none; box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15); }

        /* Notifications */
        .notification-bell { position: relative; }
        .notification-badge { position: absolute; top: 0; right: 0; font-size: 0.6rem; padding: 0.15rem 0.35rem; transform: translate(25%, -25%); }
        .notification-dropdown { width: 350px; max-height: 400px; overflow-y: auto; }
        .notification-item { border-bottom: 1px solid #eee; transition: background-color 0.2s; }
        .notification-item:last-child { border-bottom: none; }
        .notification-item:hover { background-color: #f8f9fa; }
        .notification-item.unread { background-color: #e7f3ff; }
        .notification-time { font-size: 0.75rem; color: #6c757d; }
        .notification-empty { padding: 2rem; text-align: center; color: #6c757d; }

        /* Toast notifications */
        .toast-container { position: fixed; bottom: 1rem; right: 1rem; z-index: 1080; }
        .toast { min-width: 300px; }
        .toast.toast-insert { border-left: 4px solid #198754; }
        .toast.toast-update { border-left: 4px solid #0dcaf0; }
        .toast.toast-delete { border-left: 4px solid #dc3545; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top">
        <div class="container-fluid px-3">
            <!-- Logo a n치zev -->
            <a class="navbar-brand d-flex align-items-center" href="/web/codelists">
                <i class="bi bi-journal-code me-2"></i>
                <span th:text="#{app.title}">Legislative Codelists</span>
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <!-- Lev치 캜치st - hlavn칤 navigace -->
                <ul class="navbar-nav me-auto ms-4">
                    <li class="nav-item" sec:authorize="hasAnyRole('ADMIN', 'CONTRIBUTOR')">
                        <a class="nav-link" href="/web/codelists/admin">
                            <i class="bi bi-gear me-1"></i> <span th:text="#{nav.registry}">Registry</span>
                        </a>
                    </li>
                    <li class="nav-item dropdown" sec:authorize="hasRole('ADMIN')">
                        <a class="nav-link dropdown-toggle" href="#" id="adminDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-shield-lock me-1"></i> <span th:text="#{nav.admin}">Admin</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li>
                                <a class="dropdown-item" href="/web/admin/dashboard">
                                    <i class="bi bi-speedometer2 me-2"></i> <span th:text="#{nav.dashboard}">Dashboard</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/web/users">
                                    <i class="bi bi-people me-2"></i> <span th:text="#{nav.users}">Users</span>
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" href="/web/flags">
                                    <i class="bi bi-tags me-2"></i> <span th:text="#{nav.flags}">Flags</span>
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="/web/audit">
                                    <i class="bi bi-journal-text me-2"></i> <span th:text="#{audit.title}">Audit Log</span>
                                </a>
                            </li>
                        </ul>
                    </li>
                </ul>

                <!-- Prav치 캜치st -->
                <ul class="navbar-nav align-items-center">
                    <!-- API Docs -->
                    <li class="nav-item">
                        <a class="nav-link" href="/swagger-ui.html" target="_blank" title="API Documentation">
                            <i class="bi bi-file-earmark-code me-1"></i> API
                        </a>
                    </li>

                    <li class="nav-divider d-none d-lg-block"></li>

                    <!-- Notifications -->
                    <li class="nav-item dropdown" sec:authorize="hasAnyRole('ADMIN', 'CONTRIBUTOR')">
                        <a class="nav-link dropdown-toggle notification-bell" href="#" id="notificationDropdown" role="button" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                            <i class="bi bi-bell"></i>
                            <span id="notificationBadge" class="badge rounded-pill bg-danger notification-badge" style="display: none;">0</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end notification-dropdown" aria-labelledby="notificationDropdown">
                            <li class="dropdown-header d-flex justify-content-between align-items-center px-3">
                                <span th:text="#{notification.title}">Notifications</span>
                                <button type="button" class="btn btn-link btn-sm p-0" onclick="clearNotifications()" th:title="#{notification.clearAll}">
                                    <i class="bi bi-check2-all"></i>
                                </button>
                            </li>
                            <li><hr class="dropdown-divider my-0"></li>
                            <div id="notificationList">
                                <li class="notification-empty">
                                    <i class="bi bi-bell-slash"></i>
                                    <p class="mb-0 mt-2" th:text="#{notification.empty}">No notifications</p>
                                </li>
                            </div>
                        </ul>
                    </li>

                    <li class="nav-divider d-none d-lg-block" sec:authorize="hasAnyRole('ADMIN', 'CONTRIBUTOR')"></li>

                    <!-- Jazyk -->
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="langDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-globe me-1"></i>
                            <span th:text="${#locale.language == 'cs' ? 'CZ' : 'EN'}">CZ</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li>
                                <a class="dropdown-item" th:classappend="${#locale.language == 'cs' ? 'active' : ''}" href="?lang=cs">
                                    <span class="me-2">游뻟릖</span> 캛e코tina
                                </a>
                            </li>
                            <li>
                                <a class="dropdown-item" th:classappend="${#locale.language == 'en' ? 'active' : ''}" href="?lang=en">
                                    <span class="me-2">游섫릖</span> English
                                </a>
                            </li>
                        </ul>
                    </li>

                    <li class="nav-divider d-none d-lg-block"></li>

                    <!-- U쬴vatel -->
                    <li class="nav-item dropdown user-dropdown">
                        <a class="nav-link dropdown-toggle d-flex align-items-center" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle me-1"></i>
                            <span th:text="${currentUser != null ? currentUser.displayName : #authentication.name}" class="d-none d-md-inline">username</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li class="px-3 py-2 text-muted small d-md-none">
                                <i class="bi bi-person me-1"></i> <span th:text="${currentUser != null ? currentUser.displayName : #authentication.name}">username</span>
                            </li>
                            <li class="d-md-none"><hr class="dropdown-divider"></li>
                            <li>
                                <a class="dropdown-item" href="/web/profile">
                                    <i class="bi bi-person-gear me-2"></i> <span th:text="#{nav.profile}">Profile</span>
                                </a>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <form th:action="@{/logout}" method="post" class="px-0">
                                    <button type="submit" class="dropdown-item text-danger">
                                        <i class="bi bi-box-arrow-right me-2"></i> <span th:text="#{nav.logout}">Logout</span>
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
            <span th:text="${successMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        <div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
            <span th:text="${errorMessage}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <div layout:fragment="content"></div>
    </div>

    <!-- Toast Container for Real-time Notifications -->
    <div class="toast-container" id="toastContainer" sec:authorize="hasAnyRole('ADMIN', 'CONTRIBUTOR')"></div>

    <script th:src="@{/js/bootstrap.bundle.min.js}"></script>

    <!-- Notification SSE Script -->
    <script th:inline="javascript" sec:authorize="hasAnyRole('ADMIN', 'CONTRIBUTOR')">
        /*<![CDATA[*/
        const notificationMessages = {
            insert: /*[[#{notification.action.insert}]]*/ 'created',
            update: /*[[#{notification.action.update}]]*/ 'updated',
            delete: /*[[#{notification.action.delete}]]*/ 'deleted',
            by: /*[[#{notification.by}]]*/ 'by',
            justNow: /*[[#{notification.justNow}]]*/ 'Just now',
            minutesAgo: /*[[#{notification.minutesAgo}]]*/ 'min ago',
            hoursAgo: /*[[#{notification.hoursAgo}]]*/ 'h ago',
            empty: /*[[#{notification.empty}]]*/ 'No notifications'
        };
        const currentLang = /*[[${#locale.language}]]*/ 'cs';

        let notifications = [];
        let eventSource = null;

        function initNotifications() {
            eventSource = new EventSource('/web/notifications/subscribe');

            eventSource.onopen = function() {
                console.log('SSE connection established');
            };

            // Listen for named 'codelist-change' events
            eventSource.addEventListener('codelist-change', function(event) {
                console.log('Received notification:', event.data);
                const notification = JSON.parse(event.data);
                addNotification(notification);
                showToast(notification);
            });

            // Listen for connection confirmation
            eventSource.addEventListener('connected', function(event) {
                console.log('SSE connected:', event.data);
            });

            eventSource.onerror = function(err) {
                console.error('SSE error:', err);
                eventSource.close();
                // Reconnect after 5 seconds
                setTimeout(initNotifications, 5000);
            };
        }

        function addNotification(notification) {
            notifications.unshift(notification);
            if (notifications.length > 20) {
                notifications.pop();
            }
            updateNotificationUI();
        }

        function updateNotificationUI() {
            const badge = document.getElementById('notificationBadge');
            const list = document.getElementById('notificationList');

            if (notifications.length > 0) {
                badge.style.display = 'block';
                badge.textContent = notifications.length > 9 ? '9+' : notifications.length;

                list.innerHTML = notifications.map(n => createNotificationItem(n)).join('');
            } else {
                badge.style.display = 'none';
                list.innerHTML = `<li class="notification-empty">
                    <i class="bi bi-bell-slash"></i>
                    <p class="mb-0 mt-2">${notificationMessages.empty}</p>
                </li>`;
            }
        }

        function createNotificationItem(notification) {
            const message = currentLang === 'cs' ? notification.messageCs : notification.messageEn;
            const icon = getChangeTypeIcon(notification.changeType);
            const timeAgo = formatTimeAgo(notification.timestamp);

            return `<li class="notification-item unread px-3 py-2">
                <div class="d-flex align-items-start">
                    <span class="me-2 ${getChangeTypeColor(notification.changeType)}">${icon}</span>
                    <div class="flex-grow-1">
                        <div class="small fw-semibold">${notification.codelistName}</div>
                        <div class="small text-muted">${message}</div>
                        <div class="notification-time mt-1">
                            <i class="bi bi-clock me-1"></i>${timeAgo}
                            <span class="ms-2"><i class="bi bi-person me-1"></i>${notification.changedBy}</span>
                        </div>
                    </div>
                </div>
            </li>`;
        }

        function showToast(notification) {
            const container = document.getElementById('toastContainer');
            const message = currentLang === 'cs' ? notification.messageCs : notification.messageEn;
            const toastClass = `toast-${notification.changeType.toLowerCase()}`;
            const icon = getChangeTypeIcon(notification.changeType);

            const toastHtml = `
                <div class="toast ${toastClass}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header">
                        <span class="me-2 ${getChangeTypeColor(notification.changeType)}">${icon}</span>
                        <strong class="me-auto">${notification.codelistName}</strong>
                        <small>${notificationMessages.justNow}</small>
                        <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            `;

            container.insertAdjacentHTML('beforeend', toastHtml);
            const toastEl = container.lastElementChild;
            const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 5000 });
            toast.show();

            toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
        }

        function getChangeTypeIcon(changeType) {
            switch(changeType) {
                case 'INSERT': return '<i class="bi bi-plus-circle-fill"></i>';
                case 'UPDATE': return '<i class="bi bi-pencil-fill"></i>';
                case 'DELETE': return '<i class="bi bi-trash-fill"></i>';
                default: return '<i class="bi bi-info-circle-fill"></i>';
            }
        }

        function getChangeTypeColor(changeType) {
            switch(changeType) {
                case 'INSERT': return 'text-success';
                case 'UPDATE': return 'text-info';
                case 'DELETE': return 'text-danger';
                default: return 'text-secondary';
            }
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const date = new Date(timestamp);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);

            if (diffMins < 1) return notificationMessages.justNow;
            if (diffMins < 60) return `${diffMins} ${notificationMessages.minutesAgo}`;
            if (diffHours < 24) return `${diffHours} ${notificationMessages.hoursAgo}`;
            return date.toLocaleDateString();
        }

        function clearNotifications() {
            notifications = [];
            updateNotificationUI();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initNotifications);

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
        });
        /*]]>*/
    </script>

    <th:block layout:fragment="scripts"></th:block>
</body>
</html>
